name: Version Discipline

on:
  pull_request:
    branches: [ main ]

jobs:
  check-version-and-changelog:
    name: Ensure version & changelog updates
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect code changes
        id: detect
        run: |
          git fetch origin "${{ github.base_ref }}" --depth=1
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }})
          echo "$CHANGED" > changed.txt
          NEEDS_VERSION_BUMP=0
          while read path; do
            case "$path" in
              backend/*|frontend/*|infra/*)
                NEEDS_VERSION_BUMP=1
                ;;
            esac
          done < changed.txt
          echo "needs_version_bump=$NEEDS_VERSION_BUMP" >> "$GITHUB_OUTPUT"

      - name: Check VERSION
        if: steps.detect.outputs.needs_version_bump == '1'
        run: |
          if ! git diff --name-only origin/${{ github.base_ref }} | grep -q '^VERSION$'; then
            echo "Missing VERSION bump"
            exit 1
          fi

      - name: Check CHANGELOG
        if: steps.detect.outputs.needs_version_bump == '1'
        run: |
          if ! git diff --name-only origin/${{ github.base_ref }} | grep -q '^CHANGELOG.md$'; then
            echo "Missing CHANGELOG update"
            exit 1
          fi
